<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Grafana :: santiagopastor.xyz</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Proyecto Grafana Introducción En este proyecto haré las configuraciones necesarias para monitorizar la utilización de recursos de todos los servidores desde una interfaz web.
Programas y herramientas necesarias Para cumplir este objetivo, utilizaré Telegraf como recolector de datos, InfluxDB como base de datos donde guardarlos y Grafana como interficie web para representarlos.
Telegraf Se encarga de recolectar la información que le especificamos en la configuración (Ej.: CPU/RAM/LOAD) y los envía al output configurado (Ej." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://santiagopastor.xyz/posts/grafana/" />




<link rel="stylesheet" href="http://santiagopastor.xyz/assets/style.css">

  <link rel="stylesheet" href="assets/%25!s%28%3cnil%3e%29.css">






<link rel="apple-touch-icon" href="http://santiagopastor.xyz/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="http://santiagopastor.xyz/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Grafana">
<meta property="og:description" content="Proyecto Grafana Introducción En este proyecto haré las configuraciones necesarias para monitorizar la utilización de recursos de todos los servidores desde una interfaz web.
Programas y herramientas necesarias Para cumplir este objetivo, utilizaré Telegraf como recolector de datos, InfluxDB como base de datos donde guardarlos y Grafana como interficie web para representarlos.
Telegraf Se encarga de recolectar la información que le especificamos en la configuración (Ej.: CPU/RAM/LOAD) y los envía al output configurado (Ej." />
<meta property="og:url" content="http://santiagopastor.xyz/posts/grafana/" />
<meta property="og:site_name" content="santiagopastor.xyz" />

  
    <meta property="og:image" content="img/favicon/%!s().png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-07-26 20:17:02 &#43;0200 CEST" />












</head>
<body class="">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://santiagopastor.xyz/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="http://santiagopastor.xyz/posts/grafana/">Grafana</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-07-26
        
      </span>
    
    
    
  </div>

  
  


  

  <div class="post-content"><div>
        <h1 id="proyecto-grafana">Proyecto Grafana<a href="#proyecto-grafana" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h2 id="introducción">Introducción<a href="#introducción" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>En este proyecto haré las configuraciones necesarias para monitorizar la utilización de recursos de todos los servidores desde una interfaz web.</p>
<h3 id="programas-y-herramientas-necesarias">Programas y herramientas necesarias<a href="#programas-y-herramientas-necesarias" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Para cumplir este objetivo, utilizaré Telegraf como recolector de datos, InfluxDB como base de datos donde guardarlos y Grafana como interficie web para representarlos.</p>
<h4 id="telegraf">Telegraf<a href="#telegraf" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Se encarga de recolectar la información que le especificamos en la configuración (Ej.: CPU/RAM/LOAD) y los envía al output configurado (Ej.: una base de datos).</p>
<h4 id="influxdb">InfluxDB<a href="#influxdb" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Es una base de datos en tiempo real escrita en Go. Es a donde Telegraf va a mandar la información.</p>
<h4 id="grafana">Grafana<a href="#grafana" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Es el Dashboard que se encarga de representar toda la información que InfluxDB tiene almacenado. Accederemos a este servicio desde la dirección grafana.labs.pue.es.</p>
<h4 id="traefik">Traefik<a href="#traefik" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Es la proxy inversa que vamos a utilizar para implementar el protocolo HTTPS cuando accedamos al dashboard web del Grafana y para hacer la traducción del nombre grafana.labs.pue.es a la IP y puerto del servicio (puerto 3000).</p>
<h4 id="mysql-no-obligatorio">MySQL (no obligatorio)<a href="#mysql-no-obligatorio" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Grafana viene de base con una base de datos SQLite que emplea para guardar sus usuarios, contraseñas, datasources etc. En la gran mayoría de casos esto sería suficiente, pero, Ramón me puso el desafío extra de substituir esa base de datos por un container de MySQL. Así que también lo usaré.</p>
<h3 id="objetivo-final">Objetivo final<a href="#objetivo-final" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Monitorizar los recursos de todos los servers desde el server central con un container de Grafana que se pueda ver desde la dirección de grafana.labs.pue.es. También que ese Grafana reciba la información desde un container de InfluxDB, que a su vez, recibirá la información de Telegrafs que estarán instalados tanto en local como en el resto de servers.</p>
<h3 id="pasos-seguidos">Pasos seguidos<a href="#pasos-seguidos" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ul>
<li>☒ Instalar una instancia básica en una máquina virtual</li>
<li>☒ Crea interfaz para entender como funcionan las queries de Influx</li>
<li>☒ Explicar que representa la interfaz</li>
<li>☒ Instalar en múltiples hosts con un solo dB
<ul>
<li>☒ Hacer Docker-compose para el server central con InfluxDB Grafana Y MySQL
<ul>
<li>☒ Escribir-lo</li>
<li>☒ Probarlo</li>
<li>☒ Solucionar el error con el container del grafana</li>
<li>☒ Preguntar a Ramón que le parece el compose</li>
<li>☒ Probarlo en el server central
<ul>
<li>☒ Solucionar error al acceder desde un buscador web al grafana en el server central</li>
<li>☒ Hacer que se pueda acceder a grafana desde https con traefik</li>
</ul>
</li>
</ul>
</li>
<li>☒ Haz que InfluxDB escuche por un puerto a otros servers</li>
<li>☒ Instalar telegraf fuera de los containers</li>
<li>☒ Instalar telegraf en los otros servers con ansible
<ul>
<li>☒ Escribe el archivo para que funcione con servers Ubuntu y red hat</li>
<li>☒ Prueba-lo en maquinas virtuales</li>
<li>☒ Hacer conectividad entre los servers</li>
<li>☒ Deploy</li>
</ul>
</li>
<li>☒ Crear las dashboards y confirmar que se recibe la información</li>
<li>☒ Documentar como lo he hecho, desde el compose hasta el telegraf.conf y el ansible deploy.</li>
</ul>
</li>
<li>☒ Documentar el proceso</li>
</ul>
<h2 id="documentación-del-proceso">Documentación del proceso<a href="#documentación-del-proceso" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="1-hacer-una-instalación-de-prueba-en-una-máquina-virtual-ubuntu-server">1. Hacer una instalación de prueba en una máquina virtual Ubuntu Server.<a href="#1-hacer-una-instalación-de-prueba-en-una-máquina-virtual-ubuntu-server" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="11-preparaciones-pre-instalación">1.1 Preparaciones pre-instalación<a href="#11-preparaciones-pre-instalación" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Antes de instalar nada, hacemos un &ldquo;update&rdquo; para tener los últimos repositorios y ejecutamos la orden siguiente para instalar los programas que necesitaremos para la instalación:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install curl gnupg gnupg1 gnupg2 net-tools software-properties-common
</span></span></code></pre></div><p>Estas herramientas suelen venir instaladas en la gran mayoría de distribuciones, pero no las encontraremos en una instalación de Ubuntu server mínima, así que viene bien ejecutarlo para asegurarse de que están, ya que son las herramientas que nos permitirán añadir repositorios extras.</p>
<h3 id="12-instalamos-el-software">1.2 Instalamos el software<a href="#12-instalamos-el-software" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Añadimos el repositorio de Influx para poder instalar Telegraf y InfluxDB:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo curl -sL https://repos.influxdata.com/influxdb.key | sudo apt-key add -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>source /etc/lsb-release
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;deb https://repos.influxdata.com/</span><span style="color:#e6db74">${</span>DISTRIB_ID,,<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>DISTRIB_CODENAME<span style="color:#e6db74">}</span><span style="color:#e6db74"> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/influxdb.list
</span></span></code></pre></div><p>Después actualizamos el listado de paquetes de los repositorios y instalamos InfluxDB:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo apt install influxdb
</span></span></code></pre></div><p>Iniciamos el servicio y lo activamos para que cada vez que se encienda la máquina, se encienda el servicio:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl start influxdb
</span></span><span style="display:flex;"><span>sudo systemctl enable influxdb
</span></span></code></pre></div><p>Para terminar de configurar Influx entramos en su terminal, creamos una base de datos y un usuario para la misma:</p>
<pre tabindex="0"><code class="language-influx" data-lang="influx">influx
create database telegraf
create user user_que_quieras with password &#39;la_contra_que_quieras&#39;
</code></pre><p>Después instalamos telegraf y activamos su servicio:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install telegraf
</span></span><span style="display:flex;"><span>sudo systemctl start telegraf
</span></span><span style="display:flex;"><span>sudo systemctl enable telegraf
</span></span></code></pre></div><p>Más tarde entramos en el archivo /etc/telegraf/telegraf.conf y vamos a la sección <code>[[outputs.influxdb]]</code> y des-comentamos la línea que contiene lo siguiente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#ae81ff">urls = [&#34;http://localhost:8086&#34;]</span>
</span></span></code></pre></div><p>En esa línea se especifica la URL a la que Telegraf enviara sus datos y al puerto al que lo hará. En este caso, es localhost porque es una instalación que solo se comunicara consigo misma.</p>
<p>Después añadimos el repositorio de grafana:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
</span></span><span style="display:flex;"><span>sudo add-apt-repository <span style="color:#e6db74">&#34;deb https://packages.grafana.com/oss/deb stable main&#34;</span>
</span></span></code></pre></div><p>Actualizamos los repositorios e instalamos grafana:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get update -y
</span></span><span style="display:flex;"><span>sudo apt-get install grafana -y
</span></span></code></pre></div><p>Y por último activamos e iniciamos el servicio grafana-server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl start grafana-server
</span></span><span style="display:flex;"><span>systemctl enable grafana-server
</span></span></code></pre></div><h4 id="13-configuración-de-grafana">1.3 Configuración de Grafana<a href="#13-configuración-de-grafana" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Para entrar a la UI de grafana, accedemos desde el buscador a la URL lohalhost:3000:</p>
<p><img src="/Pasted_image_20220627124826.png" alt="Pastedimage20220627124826.png" title=""></p>
<p>El login por default es admin:admin, pero una vez entras te obliga a cambiar de contraseña.</p>
<p>Una vez inicias sesión ves lo siguiente:</p>
<p><img src="/Pasted_image_20220627125135.png?1658297391991" alt="Pastedimage20220627125135.png"></p>
<p>Es la pantalla de recibimiento. Hay varios tutoriales sobre como hacer cosas básicas, noticias de las actualizaciones, etc.</p>
<p>En la sección de dashboards es donde crearemos nuestros paneles de monitorización, para crear uno nuevo le clicas a new dashboard.</p>
<p>Cada panel es una tabla que representa un query que se le hace a la base de datos. Depende de lo que quieras extraer tenderas que cambiar la query. Hay dos maneras de formular la misma.</p>
<p>Con una plantilla:</p>
<p><img src="/Pasted_image_20220627125704.png?1658297391991" alt="Pastedimage20220627125704.png"></p>
<p>O con una orden entera directamente:</p>
<p><img src="/Pasted_image_20220627125946.png?1658297391991" alt="Pastedimage20220627125946.png"></p>
<p>También se pueden importar dashboards enteros desde dashboard&gt;import utilizando el ID del dashboard que se quiere importar, su URL o subiendo un archivo .json:</p>
<p><img src="/Pasted_image_20220627130210.png?1658297391991" alt="Pastedimage20220627130210.png"></p>
<h4 id="14-mi-interfaz-personalizada">1.4 Mi interfaz personalizada<a href="#14-mi-interfaz-personalizada" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>De momento, he hecho que Grafana exponga:</p>
<ul>
<li>Tiempo que lleva la máquina encendida</li>
<li>Espacio del disco que esta siendo utilizado</li>
<li>Procesos actuales activos</li>
<li>Procesos &ldquo;zombies&rdquo;</li>
<li>Uso Total de la CPU</li>
<li>Uso Total de la RAM</li>
<li>Uso Total de la SWAP</li>
<li>Carga del sistema promedio</li>
<li>Uso de la CPU total en una timeline</li>
<li>Uso de la ram total en una timeline</li>
</ul>
<p>Foto del resultado:</p>
<p><img src="/Pasted_image_20220628131116.png?1658297391991" alt="Pastedimage20220628131116.png"></p>
<h3 id="2-instalación-en-los-servidores-reales">2 Instalación en los servidores reales<a href="#2-instalación-en-los-servidores-reales" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="21-instalar-en-el-server-central-influxdb-y-grafana-con-mysql-con-containers-y-telegraf-como-servicio">2.1 Instalar en el server central InfluxDB y Grafana con MySQL con containers y Telegraf como servicio<a href="#21-instalar-en-el-server-central-influxdb-y-grafana-con-mysql-con-containers-y-telegraf-como-servicio" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Creamos los contenedores de Grafana, InfluxDB y MySQL con el siguiente compose:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mysql</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;MYSQL_ROOT_PASSWORD=MaNF48Fc&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;MYSQL_DATABASE=grafana&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;MYSQL_USER=administrador&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;MYSQL_PASSWORD=MaNF48Fc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/data/mysql/grafana:/var/lib/mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">grafana-db </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">influx</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">influxdb:1.8.4-alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">influxdb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;10.91.240.155:8086:8086&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;INFLUXDB_REPORTING_DISABLED=true&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;INFLUXDB_DB=influx&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;INFLUXDB_ADMIN_USER=administrador&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;INFLUXDB_ADMIN_PASSWORD=MaNF48Fc&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;INFLUXDB_WRITE_USER=&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;INFLUXDB_WRITE_USER_PASSWORD=&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;INFLUXDB_DATA_QUERY_LOG_ENABLED=false&#34;</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/data/influxdb/data:/var/lib/influxdb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">grafana-db </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">grafana</span>:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">grafana/grafana</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">grafana</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_SERVER_DOMAIN=&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_SERVER_ROOT_URL&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_SECURITY_ADMIN_PASSWORD=&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_DATABASE_TYPE=mysql&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_DATABASE_SSL_MODE=verify-full&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_DATABASE_NAME=grafana&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_DATABASE_USER=administrador&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_DATABASE_HOST=mysql&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_DATABASE_PASSWORD=MaNF48Fc&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_ANALYTICS_REPORTING_ENABLED=false&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;GF_PATHS_PLUGINS=/plugins&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/data/grafana/plugins:/plugins</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik.enable=true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik.http.routers.grafana.rule=Host(`grafana.labs.pue.es`)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik.http.routers.grafana.entrypoints=web</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik.http.routers.grafana_s.rule=Host(`grafana.labs.pue.es`)</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik.http.routers.grafana_s.entrypoints=web-secure</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik.http.routers.grafana_s.tls.certresolver=letsencrypt</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik.docker.network=traefik</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">traefik</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">grafana-db</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">grafana-db</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">traefik</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>Este docker-compose, aparte de levantar los contenedores, abre el puerto 8086 desde la IP 10.91.240.155 como si fuera el puerto 8086 de la máquina host. Utilizaremos esa IP y puerto después cuando hagamos que telegraf envíe los datos hacia la base de datos en el server central.</p>
<p>Para poder hacer que Traefik traduzca el nombre y nos proporcione HTTPS hay que añadir las siguientes líneas al docker-compose.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Para decirle a traefik que exponga este container</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">traefik.enable=true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Para decirle a traefik que a traves de que dominio va a acceptar                                                     conexiones http</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">traefik.http.routers.grafana.rule=Host(`grafana.labs.pue.es`)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Para decirle a traefik el entrypoint por el que estas conexiones             tienen que entrar</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">traefik.http.routers.grafana.entrypoints=web</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Para decirle a traefik que a traves de que dominio va a acceptar                                                     conexiones https</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">traefik.http.routers.grafana_s.rule=Host(`grafana.labs.pue.es`)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Para decirle a traefik el entrypoint por el que estas conexiones             tienen que entrar</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">traefik.http.routers.grafana_s.entrypoints=web-secure</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Le indica a traefik que certificado utilizar</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">traefik.http.routers.grafana_s.tls.certresolver=letsencrypt</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Le indica la red en la que se encuentra el container de traefik</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">traefik.docker.network=traefik</span>
</span></span></code></pre></div><p>El archivo telegraf.conf que usaremos para enviar datos desde todos los servers a el server central es el siguiente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#75715e"># Configuration for sending metrics to InfluxDB</span>
</span></span><span style="display:flex;"><span>[[<span style="color:#ae81ff">outputs.influxdb]]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## The full HTTP or UDP URL for your InfluxDB instance.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## Multiple URLs can be specified for a single cluster, only ONE of the</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## urls will be written to each interval.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># urls = [&#34;unix:///var/run/influxdb.sock&#34;]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># urls = [&#34;udp://127.0.0.1:8089&#34;]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">urls = [&#34;http://10.91.240.155:8086&#34;]</span>
</span></span></code></pre></div><p>Esta vez, en vez de ser localhost, usamos la IP que el container de InfluxDB ha abierto a la intranet de servers con el puerto 8086.</p>
<h4 id="22-deploy">2.2 Deploy<a href="#22-deploy" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Para instalar y configurar telegraf en cada server, utilicé el siguiente yml de ansible:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">setup servers pue</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">servers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>: <span style="color:#ae81ff">santiago</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Update repos, instalar herramientas previas </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apt</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">update_cache</span>: <span style="color:#66d9ef">yes</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">force_apt_get</span>: <span style="color:#66d9ef">yes</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cache_valid_time</span>: <span style="color:#ae81ff">3600</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;Debian&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">instalar herramientas previas </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apt</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">curl</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">gnupg</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">gnupg1</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">gnupg2 </span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">net-tools</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">software-properties-common</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;Debian&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Import InfluxDB GPG signing key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apt_key</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">url</span>: <span style="color:#ae81ff">https://repos.influxdata.com/influxdb.key </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;Debian&#34;)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add InfluxDB repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apt_repository</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">repo</span>: <span style="color:#e6db74">&#39;deb https://repos.influxdata.com/ubuntu trusty stable&#39;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;Debian&#34;)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install telegraf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apt</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telegraf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;Debian&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Add telegraf repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">yum_repository</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">influxdb</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">description</span>: <span style="color:#ae81ff">InfluxDB Repository - RHEL $releasever</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">baseurl</span>: <span style="color:#ae81ff">https://repos.influxdata.com/rhel/$releasever/$basearch/stable</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">gpgcheck</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">gpgkey</span>: <span style="color:#ae81ff">https://repos.influxdata.com/influxdb.key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;RedHat&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install telegraf REDHAT </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telegraf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">latest</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">disablerepo</span>: <span style="color:#e6db74">&#34;*&#34;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enablerepo</span>: <span style="color:#ae81ff">influxdb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;RedHat&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Copy config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">src</span>: <span style="color:#ae81ff">./telegraf.conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/etc/telegraf/telegraf.conf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">owner</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">group</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">0644</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">restart telegraf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telegraf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">restarted</span>
</span></span></code></pre></div><p>Este ansible sirve tanto para las distros de la familia Debian como para las distros de la familia RedHat. Lo que hace es añadir el repositorio de Influx, instalar Telegraf y copiar la configuración del mismo que está en local a la dirección /etc/telegraf/telegraf.conf y reinicia el servicio para que la nueva configuración esté en efecto.</p>
<p>Mientras hacia el deploy, encontré que los servidores CentOS 8 no pueden instalar ningún paquete porque los repositorios oficiales de CentOS han sido deprecados y han cambiado de URL.</p>
<p>Para poder instalar-lo en estos servers modifiqué la siguiente parte.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install telegraf REDHAT </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">telegraf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">state</span>: <span style="color:#ae81ff">latest</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">disablerepo</span>: <span style="color:#e6db74">&#34;*&#34;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enablerepo</span>: <span style="color:#ae81ff">influxdb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">when</span>: <span style="color:#ae81ff">(ansible_facts[&#39;os_family&#39;] == &#34;RedHat&#34;)</span>
</span></span></code></pre></div><p>Obligo a yum a buscar telegraf en el repositorio influx-db des-habilitando todos los repositorios y activando solo el repositorio influx-db.</p>
<h4 id="23-dashboard">2.3 Dashboard<a href="#23-dashboard" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Para monitorizar mejor los servers, me dijeron que sería mejor que utilizaremos el dashboard estándar de Telegraf. Se puede importar con la id 928.</p>
<h2 id="conclusiones">Conclusiones<a href="#conclusiones" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Grafana es una herramienta muy útil para</p>
<h3 id="proyecto-hecho-por">Proyecto hecho por:<a href="#proyecto-hecho-por" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Santiago Pastor Serrano el 22-07-2022 a las 11:28</p>
<h3 id="tutor-de-prácticas">Tutor de prácticas<a href="#tutor-de-prácticas" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Ramón de la Rosa</p>

      </div></div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="http://santiagopastor.xyz/assets/main.js"></script>
<script src="http://santiagopastor.xyz/assets/prism.js"></script>







  
</div>

</body>
</html>
